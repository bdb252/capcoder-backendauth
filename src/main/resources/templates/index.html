<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" xmlns:sec="http://www.thymeleaf.org/thymeleaf-extras-security6">

<head>
	<meta charset="UTF-8">
	<title>Insert title here</title>
</head>

<body>
	<div class="nav-icons">
		<div class="nav-item" onclick="location.href='/'">
			<span>로고</span>
		</div>
		<div class="nav-item" onclick="location.href='/login.do'">
			<span>로그인</span>
		</div>
		<div class="nav-item" onclick="location.href='/regist.do'">
			<span>회원가입</span>
		</div>
		<div class="nav-item" onclick="location.href='/index.do'">
			<span>메인페이지</span>
		</div>
		<div class="nav-item" onclick="location.href='/mypage.do'">
			<span>마이페이지</span>
		</div>
	</div>
	<h1>캡코더</h1>

	<!-- 로그인 사용자 -->
	<section sec:authorize="isAuthenticated()">
		<h2>내 기본 정보</h2>
		<div>
			<p><strong>이름:</strong> <span th:text="${userName}">이름 없음</span></p>
			<p><strong>성별:</strong>
				<span th:if="${gender == 'F'}">여성</span>
				<span th:if="${gender == 'M'}">남성</span>
				<span th:if="${gender == null}">미입력</span>
			</p>
			<p><strong>키:</strong> <span th:text="${height}">미입력</span>cm</p>
			<p><strong>몸무게:</strong> <span th:text="${weight}">미입력</span>kg</p>
			<p><strong>생년월일:</strong> <span th:text="${birthDate}">미입력</span></p>
		</div>
	</section>

	<!-- 비로그인 전용 영역: 기본 정보 입력 폼 -->
	<section sec:authorize="isAnonymous()">
		<h2>기본 정보 입력 후 예측</h2>
		<form id="userInfoForm">
			<p>이름 <input name="name" required></p>
			<p>성별
				<select name="gender" required>
					<option value="">선택</option>
					<option value="M">남성</option>
					<option value="F">여성</option>
				</select>
			</p>
			<p>생년월일 <input name="birthDate" type="date" required></p>
			<p>키(cm) <input name="height" type="number" step="0.1" required></p>
			<p>몸무게(kg) <input name="weight" type="number" step="0.1" required></p>
		</form>
	</section>

	<!-- 공통 영역 : 식단 입력 및 예측 -->
	<section>
		<h2>음식 이미지 분석</h2>
		<div class="upload-section">
			<h3>이미지 선택</h3>
			<input type="file" id="imageInput" accept="image/*">
			<p>JPG, PNG 등 이미지 파일을 선택하세요</p>
		</div>

		<div class="preview" id="preview" style="display: none;">
			<h3>미리보기</h3>
			<img id="previewImage" src="" alt="미리보기">
		</div>

		<button id="submitBtn" disabled onclick="uploadImage()">
			영양 성분 분석
		</button>

		<div id="loading" class="response loading" style="display: none;">
			<p>⏳ AI가 이미지를 분석 중입니다...</p>
		</div>

		<div id="response" style="display: none;">
			<h3>응답 결과</h3>
			<pre id="responseText"></pre>
		</div>

		<!-- 예측 버튼 -->
		<form method="post" action="/predict/model">
			<button type="submit">예측 실행</button>
		</form>
	</section>
</body>
<script>
	const imageInput = document.getElementById('imageInput');
	const preview = document.getElementById('preview');
	const previewImage = document.getElementById('previewImage');
	const submitBtn = document.getElementById('submitBtn');
	const loading = document.getElementById('loading');
	const response = document.getElementById('response');
	const responseText = document.getElementById('responseText');

	let selectedFile = null;

	// 이미지 선택 시 미리보기
	imageInput.addEventListener('change', function (e) {
		const file = e.target.files[0];
		if (file) {
			selectedFile = file;

			// 미리보기 표시
			const reader = new FileReader();
			reader.onload = function (e) {
				previewImage.src = e.target.result;
				preview.style.display = 'block';
			};
			reader.readAsDataURL(file);

			// 버튼 활성화
			submitBtn.disabled = false;

			// 이전 응답 숨기기
			response.style.display = 'none';
		}
	});

	// 이미지 업로드 함수
	async function uploadImage() {
		if (!selectedFile) {
			alert('이미지를 먼저 선택해주세요!');
			return;
		}

		// FormData 생성
		const formData = new FormData();
		formData.append('image', selectedFile);

		// UI 업데이트
		loading.style.display = 'block';
		response.style.display = 'none';
		submitBtn.disabled = true;

		try {
			// API 호출 'https://capcoder-backendauth.onrender.com/api/gemini/imagedb'
			//http://localhost:8077/api/gemini/imagedb
			const res = await fetch('https://capcoder-backendauth.onrender.com/api/gemini/imagedb', {
				method: 'POST',
				body: formData
			});

			const data = await res.text();

			// 응답 표시
			loading.style.display = 'none';
			response.style.display = 'block';
			response.className = 'response';

			// JSON 형태면 포맷팅
			try {
				const jsonData = JSON.parse(data);
				responseText.textContent = JSON.stringify(jsonData, null, 2);
			} catch {
				responseText.textContent = data;
			}

		} catch (error) {
			// 에러 표시
			loading.style.display = 'none';
			response.style.display = 'block';
			response.className = 'response error';
			responseText.textContent = '에러 발생: ' + error.message;
		} finally {
			// 버튼 다시 활성화
			submitBtn.disabled = false;
		}
	}
</script>

</html>